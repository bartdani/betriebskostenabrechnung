# Projekt: Verwaltungssoftware Mietwohnungen

## Übergreifende Aufgaben
- [X] Initiale Anforderungsanalyse abgeschlossen (Basis: projectbrief.md)
- [X] `requirements.txt` Datei erstellen
- [X] Conda-Umgebung `env` erstellen
- [X] Git-Repository initialisieren und mit GitHub verbinden
- [X] `README.md` erstellen und pushen
- [X] SQLAlchemy LegacyAPIWarnings beheben
- [X] Basis UI-Layout und Navigation implementieren - Completed on 2024-08-08
  - [X] Bootstrap Navbar in `_base.html` erstellen/anpassen
  - [X] Index-Route (`/`) erstellen/anpassen, um Basis-Layout zu rendern
  - [X] Navigationslinks für Hauptbereiche (Dashboard, Stammdaten, etc.) hinzufügen

## Phase 1: Grundgerüst & Basis-CRUD (ca. 4-5 Wochen)
- [X] Flask-Setup mit Grundstruktur (Authentifizierung optional/später)
  - [X] Test für Grundstruktur/Erreichbarkeit erstellen (`test/test_app_basic.py`)
- [X] Datenbankmodell für Kern-Stammdaten erweitern
  - [X] Modelle für `Apartment`, `Tenant`, `Contract`, `Meter`, `Invoice` definieren/anpassen (Invoice mit Zuordnungstyp: Schlüssel-ID oder Mieter/Vertrags-ID)
  - [X]   1. Analyse: Bestehende Modelle in `app/models.py` analysieren.
  - [X]   2. Kreativphase (Modell-Design): Attribute/Beziehungen definieren (v.a. Invoice Zuordnung).
  - [X]   3. Implementierung `Apartment`-Modell: Attribute/Beziehungen hinzufügen/anpassen.
  - [X]   4. Implementierung `Tenant`-Modell: Attribute/Beziehungen hinzufügen/anpassen.
  - [X]   5. Implementierung `Contract`-Modell: Attribute/Beziehungen hinzufügen/anpassen (inkl. FK zu Tenant, Apartment).
  - [X]   6. Implementierung `Meter`-Modell: Attribute/Beziehungen hinzufügen/anpassen (inkl. FK zu Apartment).
  - [X]   7. Implementierung `Invoice`-Modell: Attribute/Beziehungen hinzufügen/anpassen (inkl. FK zu CostType, Zuordnung logic: FK zu Contract ODER FK zu AllocationKey).
  - [X]   8. Code schreiben/anpassen: Modelle in `app/models.py` implementieren.
  - [X]   9. Migration generieren: `flask db migrate -m "Expand core data models"`.
  - [X]   10. Migration anwenden: `flask db upgrade`.
  - [X]   11. Tests anpassen/erweitern: `test/test_db_models_basic.py`.
  - [X]   12. Tests ausführen: Sicherstellen, dass alle Modelltests erfolgreich sind.
  - [X] Migrationen generieren und anwenden // *Verschoben in detaillierte Schritte*
  - [X] Test für DB-Modell Basis erstellen (`test/test_db_models_basic.py`) // Ggf. erweitern // *Wird in Schritt 11 angepasst*
- [ ] Basis-CRUD-UI für Wohnungen implementieren
  - [ ] Blueprint, Forms, Routes, Templates für Apartments (List, Create, Edit View)
  - [ ] Test für Apartment CRUD erstellen (`test/test_crud_apartments.py`)
- [ ] Basis-CRUD-UI für Mieter implementieren
  - [ ] Blueprint, Forms, Routes, Templates für Tenants (List, Create, Edit View)
  - [ ] Test für Tenant CRUD erstellen (`test/test_crud_tenants.py`)
- [ ] Basis-CRUD-UI für Zähler implementieren
  - [ ] Blueprint, Forms, Routes, Templates für Meters (List, Create, Edit View)
  - [ ] Zuordnung Zähler zu Wohnung ermöglichen
  - [ ] Test für Meter CRUD erstellen (`test/test_crud_meters.py`)
- [X] Basis CSV-Import für Zählerstände implementieren
  - [X] Test für CSV-Import Basis erstellen (`test/test_csv_import_basic.py`)
- [X] Implement CSV Import for Tenant Data - Completed on 2024-08-08
  - [X] Define CSV format (Headers: `Name`, `Kontaktinfo`)
  - [X] Create import function `import_tenant_csv` in `app/import_data.py`
  - [X] Implement CSV reading and data validation
  - [X] Implement Tenant object creation and DB insertion
  - [X] Add error handling and reporting (skipped rows)
  - [X] Create tests for `import_tenant_csv` (`test/test_csv_import_tenant.py`)

## Phase 2: Kernfunktionen Abrechnung & Erweiterte CRUD (ca. 7-8 Wochen)
- [X] Betriebskostenabrechnungs-Logik implementieren (Basis)
  - [X] Kostenverteilung (Verbrauchsbasiert)
    - [X] Test für verbrauchsbasierte Verteilung erstellen (`test/test_cost_alloc_consumption.py`)
  - [X] Kostenverteilung (Anteilsbasiert)
    - [X] Test für anteilsbasierte Verteilung erstellen (`test/test_cost_alloc_share.py`)
  - [X] Kostenverteilung (Personentage pro-rata) - Completed on 2024-08-02
    - [X] Datenmodell für Bewohnerzahl-Zeiträume erstellen/erweitern (z.B. `OccupancyPeriod`)
    - [X] Logik für Personentage-Berechnung implementieren
    - [X] Test für Personentage-Verteilung erstellen (`test/test_cost_alloc_persondays.py`)
  - [X] Kombination von Schlüsseln ermöglichen (2024-08-01)
    - [X] Funktion `calculate_combined_allocation` in `app/calculations.py` implementieren
    - [X] Test `test/test_cost_alloc_combined.py` erstellen
  - [X] Refactoring: Konsistente Rückgabewerte für Verteilungsfunktionen (immer Dict) (2024-08-01)
- [ ] Spezifische Heizkostenabrechnungs-Logik implementieren
  - [ ] Datenmodell anpassen (falls nötig für Brennstoffkosten/Aufteilung)
  - [ ] Funktion zur Erfassung/Zuordnung von Brennstoffkosten entwickeln
  - [ ] Logik zur Aufteilung Brennstoffkosten (Wärme/Warmwasser, ggf. über Zeiträume) implementieren
  - [ ] Verteilungslogik für Wärme- und Warmwasserkosten integrieren
  - [ ] Test für spezifische Heizkostenlogik erstellen (`test/test_cost_alloc_heating.py`)
- [ ] Logik für direkte Kostenzuordnung implementieren
  - [ ] Anpassung der Abrechnungsfunktion zur Berücksichtigung direkt zugeordneter Kosten
  - [ ] Test für direkte Kostenzuordnung erstellen (`test/test_cost_alloc_direct.py`)
- [X] UI für benutzerdefinierte Kostenverteilschlüssel erstellen - Completed on 2024-08-08
  - [X] Tests für Logik der benutzerdef. Schlüssel (`test/test_custom_keys.py`)
- [ ] UI für Verwaltung von Bewohnerzahl-Zeiträumen implementieren
  - [ ] Integration in Mieter-Bearbeitungsview
  - [ ] Formular/Logik zum Hinzufügen, Bearbeiten, Löschen von `OccupancyPeriod`-Einträgen
  - [ ] Test für OccupancyPeriod UI erstellen (`test/test_ui_occupancy.py`)
- [ ] UI für Erfassung von Kostenbelegen/Rechnungen implementieren
  - [ ] Blueprint, Forms, Routes, Templates für Invoices (List, Create, Edit View)
  - [ ] Formular-Logik zur Auswahl: Verteilungsschlüssel ODER direkte Zuordnung zu Mieter/Vertrag
  - [ ] Test für Invoice CRUD (inkl. Zuordnungsauswahl) erstellen (`test/test_crud_invoices.py`)
- [ ] Erweiterte CRUD-UI für Verträge implementieren
  - [ ] Blueprint, Forms, Routes, Templates für Contracts (List, Create, Edit View)
  - [ ] Verknüpfung Mieter/Wohnung, Erfassung Indexklausel etc.
  - [ ] Test für Contract CRUD erstellen (`test/test_crud_contracts.py`)
- [X] PDF-Generierung für Betriebs/Neben- und Heizkostenabrechnungen - Completed on 2024-08-08
  - [X] Test für PDF-Generierung Basis erstellen (`test/test_pdf_generation_basic.py`)
  - [ ] Betriebskostenabrechnung PDF-Generierung erweitern (Anteilige Kosten, direkte Kosten)
  - [ ] Heizkostenabrechnung PDF-Generierung erweitern (spezifische Heizkostenlogik)
- [ ] Manuelle Datenerfassung für Zählerstände/Verbräuche implementieren
  - [ ] UI-Maske für Zählerstände (pro Zähler)
  - [ ] UI-Maske für allgemeine Verbrauchsdaten (pro Wohnung/Kostenart)
  - [ ] Datenbank-Speicherung mit `entry_type='manual'` (Versionierung optional/später prüfen)
  - [ ] Test für manuelle Verbrauchsdatenerfassung (`test/test_manual_consumption_entry.py`)
- [ ] Warnsystem für Abrechnungsprüfung implementieren
  - [ ] Test für Warnsystem-Logik erstellen (`test/test_validation_warnings.py`)
  - [ ] Logik für Plausibilitätschecks (fehlende Stände, Sprünge, Vorauszahlungen, fehlende Kosten)
  - [ ] Warnungsdashboard/Anzeige im Abrechnungsmodul

## Phase 3: Index & Abschluss CRUD (ca. 3-4 Wochen)
- [ ] VPI-Datenimport ermöglichen (manuell/CSV/API)
  - [ ] Implementierung CSV-Import
  - [ ] Implementierung API-Import (Statistik Austria)
  - [ ] Test für VPI-Datenimport erstellen (`test/test_vpi_import.py`)
- [ ] Automatische Berechnung der Indexanpassung implementieren
  - [ ] Test für Indexanpassungsberechnung erstellen (`test/test_index_calculation.py`)
- [ ] Generierung von Mieterhöhungsschreiben (PDF)
  - [ ] Test für PDF-Generierung (Erhöhung) erstellen (`test/test_pdf_generation_increase.py`)
- [ ] Fertigstellung CRUD-Operationen
  - [ ] Löschen-Funktionen für alle Stammdaten implementieren (mit Bestätigung/Checks)
  - [ ] Detailansichten für alle Stammdaten implementieren
  - [ ] Tests für Löschen/Detailansichten erweitern
- [ ] Dokumentenmanagement implementieren (Vertragsarchivierung)
  - [X] Dokumentenarchivierung für Verträge integrieren (PDF-Upload/Speicherung) - *Verschoben von Phase 2*
    - [X] Test für Dokumentenarchivierung erstellen (`test/test_document_storage.py`) - *Verschoben von Phase 2*
  - [ ] Archivierung für Mieterhöhungsschreiben hinzufügen

## Phase 4: Test, Doku & Feinschliff (ca. 4 Wochen)
- [ ] Umfassende Integrations- und End-to-End-Tests schreiben (Ergänzung zu Unit-Tests)
  - [ ] Testfall: Kompletter Abrechnungslauf mit Mieterwechsel & Heizkosten & direkten Kosten
  - [ ] Testfall: CRUD-Operationen über den gesamten Lebenszyklus von Stammdaten
  - [ ] Testfall: Manuelle vs. importierte Daten Konsistenzcheck (Integration)
  - [ ] Testfall: Warnungsgenerierung bei fehlenden Daten (Integration)
- [ ] Benutzerhandbuch erstellen (Schwerpunkt: Stammdatenverwaltung, Schlüssel, Kostenerfassung (direkt/verteilt), Abrechnungsprozess, Heizkosten)
- [ ] Dashboard & Berichte implementieren (Visualisierung Kostenverteilung, CSV/Excel-Export)
  - [ ] Test für Dashboard/Berichtslogik erstellen (`test/test_dashboard_reports.py`)
- [ ] Dokumentenmanagement erweitern (Suche/Filter)
  - [ ] Test für erweiterte Doku-Features erstellen (`test/test_document_mgmt_advanced.py`)
- [ ] Performance-Optimierung sicherstellen (< 5 Sek. für 15 WE, UI < 1 Sek)
  - [ ] Performance-Tests implementieren (`test/test_performance.py`)
- [ ] DSGVO-Konformität prüfen und sicherstellen
- [ ] Revisionssichere Archivierung von PDFs gewährleisten
- [ ] Benutzerfreundlichkeit & Responsive Design verbessern
- [ ] User Authentication & Authorization

## Phase 5: Datensicherung (ca. 1-2 Wochen)
- [ ] Spezifikation Datensicherung definieren (Was, Wie oft, Ziel: Google Drive)
- [ ] Implementierung Google Drive API Integration
  - [ ] Authentifizierung (OAuth 2.0)
  - [ ] Backup-Funktion (DB-Dump, relevante Dateien)
  - [ ] Optional: Restore-Funktion
- [ ] UI für Backup-Konfiguration/Ausführung
- [ ] Test für Datensicherung erstellen (`test/test_backup.py`)