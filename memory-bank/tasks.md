# Projekt: Verwaltungssoftware Mietwohnungen

## Übergreifende Aufgaben
- [X] Initiale Anforderungsanalyse abgeschlossen (Basis: projectbrief.md)
- [X] `requirements.txt` Datei erstellen
- [X] Conda-Umgebung `env` erstellen
- [X] Git-Repository initialisieren und mit GitHub verbinden
- [X] `README.md` erstellen und pushen
- [X] SQLAlchemy LegacyAPIWarnings beheben
- [X] Basis UI-Layout und Navigation implementieren - Completed on 2024-08-08
  - [X] Bootstrap Navbar in `_base.html` erstellen/anpassen
  - [X] Index-Route (`/`) erstellen/anpassen, um Basis-Layout zu rendern
  - [X] Navigationslinks für Hauptbereiche (Dashboard, Stammdaten, etc.) hinzufügen

## Phase 1: Grundgerüst (ca. 4 Wochen)
- [X] Flask-Setup mit Grundstruktur (Authentifizierung optional/später)
  - [X] Test für Grundstruktur/Erreichbarkeit erstellen (`test/test_app_basic.py`)
- [X] Datenbankmodell Basis implementieren (Mieter, Kostenarten, initiale Verbrauchsdaten-Tabelle)
  - [X] Test für DB-Modell Basis erstellen (`test/test_db_models_basic.py`)
- [X] Basis CSV-Import für Zählerstände implementieren
  - [X] Test für CSV-Import Basis erstellen (`test/test_csv_import_basic.py`)
- [X] Implement CSV Import for Tenant Data - Completed on 2024-08-08
  - [X] Define CSV format (Headers: `Name`, `Kontaktinfo`)
  - [X] Create import function `import_tenant_csv` in `app/import_data.py`
  - [X] Implement CSV reading and data validation
  - [X] Implement Tenant object creation and DB insertion
  - [X] Add error handling and reporting (skipped rows)
  - [X] Create tests for `import_tenant_csv` (`test/test_csv_import_tenant.py`)

## Phase 2: Kernfunktionen (ca. 6 Wochen)
- [X] Mieterverwaltung implementieren
  - [X] Mietverträge erfassen (inkl. Indexklauseln, Kostenverteilschlüssel-Zuordnung)
    - [X] Test für Mietervertragslogik erstellen (`test/test_tenant_contracts.py`)
  - [X] Dokumentenarchivierung für Verträge integrieren (PDF-Upload/Speicherung)
    - [X] Test für Dokumentenarchivierung erstellen (`test/test_document_storage.py`)
- [X] Betriebskostenabrechnungs-Logik implementieren
  - [X] Kostenverteilung (Verbrauchsbasiert)
    - [X] Test für verbrauchsbasierte Verteilung erstellen (`test/test_cost_alloc_consumption.py`)
  - [X] Kostenverteilung (Anteilsbasiert)
    - [X] Test für anteilsbasierte Verteilung erstellen (`test/test_cost_alloc_share.py`)
  - [X] Kostenverteilung (Personentage pro-rata) - Completed on 2024-08-02
    - [X] Datenmodell für Bewohnerzahl-Zeiträume erstellen/erweitern (z.B. `OccupancyPeriod`)
      - [X] Define `OccupancyPeriod` model in `app/models.py` (`apartment_id`, `start_date`, `end_date`, `number_of_occupants`)
      - [X] Generate DB migration script for `OccupancyPeriod`
      - [X] Apply DB migration
    - [X] Logik für Personentage-Berechnung implementieren
      - [X] Implement helper function to get relevant occupancy periods for a given apartment and billing period in `app/calculations.py`
      - [X] Implement `calculate_person_days` function in `app/calculations.py`
      - [X] Implement `calculate_person_day_allocation` function in `app/calculations.py`
    - [X] Test für Personentage-Verteilung erstellen (`test/test_cost_alloc_persondays.py`)
      - [X] Create test file `test/test_cost_alloc_persondays.py`
      - [X] Write test cases for `OccupancyPeriod` model
      - [X] Write test cases for `calculate_person_days` helper function
      - [X] Write test cases for `calculate_person_day_allocation`
      - [X] Ensure all tests pass
  - [X] Kombination von Schlüsseln ermöglichen (2024-08-01)
    - [X] Funktion `calculate_combined_allocation` in `app/calculations.py` implementieren
    - [X] Test `test/test_cost_alloc_combined.py` erstellen
    - [X] Reflektion und Archivierung
  - [X] Refactoring: Konsistente Rückgabewerte für Verteilungsfunktionen (immer Dict) (2024-08-01)
    - [X] `app/calculations.py` anpassen
    - [X] Relevante Tests anpassen (`test/test_cost_alloc_*.py`)
- [X] UI für benutzerdefinierte Kostenverteilschlüssel erstellen - Completed on 2024-08-08
  - [X] Abhängigkeiten hinzufügen
    - [X] `Flask-WTF` zu `requirements.txt` hinzufügen
    - [X] Abhängigkeiten installieren (`pip install -r requirements.txt`)
  - [X] Formular definieren (`app/forms.py`)
    - [X] `CostTypeForm` mit Feldern `name`, `unit`, `type` (SelectField) erstellen
  - [X] Flask Blueprint erstellen (`app/cost_types/routes.py`)
    - [X] Blueprint `cost_types_bp` definieren
    - [X] Blueprint in `app/__init__.py` registrieren
  - [X] (Creative Phase - UI Design)
    - [X] Layout für Listenseite entwerfen (Tabelle, Buttons)
    - [X] Design für Formularseite entwerfen (Erstellen/Bearbeiten)
    - [X] Bootstrap-Styling planen
    - [X] Anzeige von Validierungsfehlern planen
  - [X] Routen und Logik implementieren (`app/cost_types/routes.py`)
    - [X] Route für Liste (GET)
    - [X] Route für Erstellen (GET, POST)
    - [X] Route für Bearbeiten (GET, POST)
    - [X] Route für Löschen (POST/DELETE mit Bestätigung)
  - [X] Templates erstellen (`app/templates/cost_types/`)
    - [X] `list_cost_types.html` erstellen
    - [X] `create_edit_cost_type.html` erstellen
    - [X] Basis-Template anpassen/erweitern
    - [X] Flask-WTF Makros verwenden
  - [X] Test für Logik der benutzerdef. Schlüssel erstellen (`test/test_custom_keys.py`)
    - [X] Testdatei erstellen
    - [X] Tests für GET-Routen schreiben
    - [X] Tests für POST-Routen (Erstellen, Bearbeiten, Löschen) schreiben
    - [X] Validierungstests schreiben
  - [X] Tests ausführen und debuggen
- [X] PDF-Generierung für Betriebs- und Heizkostenabrechnungen (Basisversion) - Completed on 2024-08-08
  - [X] Create PDF generation function `generate_utility_statement_pdf` (e.g., in `app/pdf_generation.py`)
  - [X] Define function signature (e.g., needs contract_id, period_start, period_end, cost_items)
  - [X] Implement data fetching logic (Contract, Tenant, Apartment, CostType details, Allocation results from `calculations.py`)
  - [X] Implement basic PDF structure using `reportlab` (Header, Address, Cost Table, Summary)
  - [X] Handle basic formatting (Paragraphs, Tables)
  - [X] Save PDF to a file or return as byte stream
  - [X] Test für PDF-Generierung Basis erstellen (`test/test_pdf_generation_basic.py`)
    - [X] Create test file
    - [X] Setup basic test data (Tenant, Apt, Contract, Costs)
    - [X] Call generation function
    - [X] Assert PDF is created (e.g., check file existence or stream content type/length)
    - [X] Optional: Basic content check (e.g., presence of tenant name)
- [ ] Manuelle Datenerfassung ermöglichen (für alle Importtypen)
  - [ ] Datenbankerweiterung: Spalte `entry_type` zu `consumption_data` hinzufügen
    - [ ] Spalte in `app/models.py` definieren
    - [ ] Migration generieren (`flask db migrate -m \"add entry_type to consumption_data\"`)
    - [ ] Migration anwenden (`flask db upgrade`)
  - [ ] Formular erstellen: `ManualConsumptionForm` in `app/forms.py` definieren
    - [ ] Felder: `apartment_id` (SelectField), `cost_type_id` (SelectField), `date` (DateField), `value` (FloatField)
    - [ ] SelectFields dynamisch befüllen (Apartments, CostTypes)
  - [ ] Blueprint/Routen erstellen: `manual_entry_bp` in `app/manual_entry/routes.py`
    - [ ] Blueprint definieren und registrieren
    - [ ] Route `/manual_entry/consumption` (GET/POST) implementieren
    - [ ] Validierungs- und Speicherlogik hinzufügen (`entry_type='manual'`)
    - [ ] Flash-Nachrichten implementieren
  - [ ] Template erstellen: `consumption_entry.html` in `app/templates/manual_entry/`
    - [ ] Formular mit `bootstrap_wtf` rendern
    - [ ] Validierungsfehler und Flash-Nachrichten anzeigen
  - [ ] Navigation anpassen: Link in `_base.html` hinzufügen
  - [ ] Test für manuelle Datenerfassung erstellen (`test/test_manual_data_entry.py`)
    - [ ] Testdatei erstellen
    - [ ] Tests für GET und POST (valide/invalide Daten) schreiben
    - [ ] Test für korrekte DB-Speicherung (`entry_type`) schreiben
  - [ ] UI-Maske für manuelle Zählerstandserfassung // Alte Unteraufgabe (ersetzt durch obige)
- [ ] Warnsystem für Abrechnungsprüfung implementieren
  - [ ] Test für Warnsystem-Logik erstellen (`test/test_validation_warnings.py`)
  - [ ] Logik für Plausibilitätschecks (fehlende Stände, Sprünge, Vorauszahlungen)
  - [ ] Warnungsdashboard/Anzeige im Abrechnungsmodul

## Phase 3: Index-Mieterhöhungen (ca. 2 Wochen)
- [ ] VPI-Datenimport ermöglichen (manuell/CSV)
  - [ ] Test für VPI-Datenimport erstellen (`test/test_vpi_import.py`)
- [ ] Automatische Berechnung der Indexanpassung implementieren
  - [ ] Test für Indexanpassungsberechnung erstellen (`test/test_index_calculation.py`)
- [ ] Generierung von Mieterhöhungsschreiben (PDF)
  - [ ] Test für PDF-Generierung (Erhöhung) erstellen (`test/test_pdf_generation_increase.py`)

## Phase 4: Test & Dokumentation (ca. 3 Wochen)
- [ ] Umfassende Integrations- und End-to-End-Tests schreiben (Ergänzung zu Unit-Tests)
  - [ ] Testfall: Kompletter Abrechnungslauf mit Mieterwechsel
  - [ ] Testfall: Manuelle vs. importierte Daten Konsistenzcheck (Integration)
  - [ ] Testfall: Warnungsgenerierung bei fehlenden Daten (Integration)
- [ ] Benutzerhandbuch erstellen (Schwerpunkt: Schlüsselverwaltung, Abrechnungsprozess)

## Weitere Features & Nicht-Funktionale Anforderungen
- [ ] Dokumentenmanagement erweitern (Langzeitarchivierung, Suchfilter)
  - [ ] Test für erweiterte Doku-Features erstellen (`test/test_document_mgmt_advanced.py`)
- [ ] Dashboard & Berichte implementieren (Visualisierung Kostenverteilung, CSV/Excel-Export)
  - [ ] Test für Dashboard/Berichtslogik erstellen (`test/test_dashboard_reports.py`)
- [ ] Performance-Optimierung sicherstellen (< 5 Sek. für 15 WE)
  - [ ] Performance-Tests implementieren (`test/test_performance.py`)
- [ ] DSGVO-Konformität prüfen und sicherstellen
- [ ] Revisionssichere Archivierung von PDFs gewährleisten
- [ ] Benutzerfreundlichkeit & Responsive Design verbessern
- [ ] User Authentication & Authorization

## Completed Tasks
- [X] Überarbeitung der Personentage-Berechnung - Abgeschlossen am 2024-04-01
  - Entfernung redundanter Code (person_days.py)
  - Korrektur der Personentage-Berechnung
  - Verbesserte Validierung in WTForms
  - Alle Tests erfolgreich (67 Tests)

