{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h1>{{ title }}</h1>

  {% if step == '1' or not step %}
  <form method="POST" class="row g-3 mt-2">
    <input type="hidden" name="step" value="1" />
    <div class="col-md-4">
      <label class="form-label">Vertrag</label>
      <select name="contract_id" class="form-select" required>
        {% for c in contracts %}
          <option value="{{ c.id }}">#{{ c.id }} - {{ c.tenant.name if c.tenant else 'N/A' }} (Wohnung {{ c.apartment.number if c.apartment else 'N/A' }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Start</label>
      <input type="date" name="period_start" class="form-control" required />
    </div>
    <div class="col-md-3">
      <label class="form-label">Ende</label>
      <input type="date" name="period_end" class="form-control" required />
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" name="action" value="next">Weiter</button>
    </div>
  </form>
  {% endif %}

  {% if step == '2' %}
  <form method="POST" class="mt-2">
    <input type="hidden" name="step" value="2" />
    <input type="hidden" name="contract_id" value="{{ contract_id }}" />
    <input type="hidden" name="period_start" value="{{ period_start }}" />
    <input type="hidden" name="period_end" value="{{ period_end }}" />

    <div class="row g-3">
      <div class="col-md-4">
        <fieldset class="border rounded p-2">
          <legend class="float-none w-auto px-2">Anteile (Share)</legend>
          {% for ct in share_types %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="share_ids" value="{{ ct.id }}" id="share_{{ ct.id }}" />
              <label class="form-check-label" for="share_{{ ct.id }}">{{ ct.name }} ({{ ct.unit }})</label>
            </div>
          {% endfor %}
        </fieldset>
      </div>
      <div class="col-md-4">
        <fieldset class="border rounded p-2">
          <legend class="float-none w-auto px-2">Verbrauch</legend>
          {% for ct in consumption_types %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="consumption_ids" value="{{ ct.id }}" id="cons_{{ ct.id }}" />
              <label class="form-check-label" for="cons_{{ ct.id }}">{{ ct.name }} ({{ ct.unit }})</label>
            </div>
          {% endfor %}
        </fieldset>
      </div>
      <div class="col-md-4">
        <fieldset class="border rounded p-2">
          <legend class="float-none w-auto px-2">Personentage</legend>
          {% for ct in person_day_types %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="person_days_ids" value="{{ ct.id }}" id="pd_{{ ct.id }}" />
              <label class="form-check-label" for="pd_{{ ct.id }}">{{ ct.name }} ({{ ct.unit }})</label>
            </div>
          {% endfor %}
        </fieldset>
      </div>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-md-6">
        <fieldset class="border rounded p-2">
          <legend class="float-none w-auto px-2">Heizpaket</legend>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" name="use_heating" id="use_heating">
            <label class="form-check-label" for="use_heating">Heizung/Warmwasser einbeziehen</label>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Heizung</label>
              <select class="form-select" name="heating_ct_id">
                {% for ct in heating_candidates %}
                  <option value="{{ ct.id }}">{{ ct.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Warmwasser</label>
              <select class="form-select" name="hot_water_ct_id">
                {% for ct in hot_water_candidates %}
                  <option value="{{ ct.id }}">{{ ct.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mt-2">
            <label class="form-label">Warmwasser-Anteil (%)</label>
            <input type="number" name="hot_water_percentage" class="form-control" min="0" max="100" step="1" value="30" />
          </div>
        </fieldset>
      </div>
      <div class="col-md-6">
        <fieldset class="border rounded p-2">
          <legend class="float-none w-auto px-2">Direktkosten</legend>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="use_direct" id="use_direct" checked>
            <label class="form-check-label" for="use_direct">Direkte Zuordnungen berücksichtigen</label>
          </div>
        </fieldset>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button name="action" value="preview" class="btn btn-outline-secondary">Vorschau</button>
      <button name="action" value="pdf" class="btn btn-primary">PDF erzeugen</button>
    </div>

    {% if preview_rows %}
    <div class="card mt-4">
      <div class="card-header">Vorschau</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Position</th>
                <th class="text-end">Gesamtkosten</th>
                <th>Verteilschlüssel</th>
                <th class="text-end">Ihr Anteil</th>
              </tr>
            </thead>
            <tbody>
              {% for row in preview_rows %}
              <tr>
                <td>{{ row.name }}</td>
                <td class="text-end">{{ row.total_cost_fmt }}</td>
                <td>{{ row.key_desc }}</td>
                <td class="text-end">{{ row.tenant_share_fmt }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th>Summe</th>
                <th></th>
                <th></th>
                <th class="text-end">{{ preview_total_fmt }}</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
  </form>
  {% endif %}
</div>
{% endblock %}


